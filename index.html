<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpecCom | Field Verification</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <span class="brand-mark">GT</span>
        <div>
          <div class="brand-title">SpecCom</div>
          <div class="muted small" data-i18n="brandSubtitle">Field verification, documentation, and billing control</div>
        </div>
      </div>
      <div class="row">
        <span id="appModeBadge" class="badge">DEMO</span>
        <span id="demoEnvBadge" class="badge demo" style="display:none;" data-i18n="demoEnvBadge">DEMO ENVIRONMENT</span>
        <span id="whoami" class="badge">Signed out</span>
        <button id="btnSignOut" class="btn secondary" style="display:none;" data-i18n="signOut">Sign out</button>
      </div>
    </div>

    <div class="spacer"></div>
    <div id="envWarning" class="note" style="display:none;"></div>

    <div id="viewAuth" class="stack">
      <div class="auth-wrap">
        <div class="card auth-card">
          <h1 data-i18n="authTitle">Sign in to SpecCom</h1>

          <div class="hr"></div>

          <div class="field-stack">
            <input id="email" class="input" placeholder="email" data-i18n-placeholder="emailPlaceholder" />
            <input id="password" class="input" placeholder="password" type="password" data-i18n-placeholder="passwordPlaceholder" />
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="btnSignIn" class="btn" data-i18n="signIn">Sign in</button>
            <button id="btnSignUp" class="btn secondary" data-i18n="createUser">Create account</button>
            <button id="btnDemoLogin" class="btn ghost" data-i18n="demoLogin">Demo login</button>
          </div>
        </div>
      </div>
    </div>

    <div id="viewApp" class="app-shell" style="display:none;">
      <aside class="sidebar">
        <div class="card sidebar-card">
          <div class="muted small">Active project</div>
          <select id="projectSelect" class="input">
            <option value="" data-i18n="selectProject">Select project</option>
          </select>
          <div id="projectMeta" class="muted small" style="margin-top:8px;"></div>
        </div>
        <nav class="nav">
          <button class="nav-item active" data-view="viewDashboard" data-i18n="navDashboard">Dashboard</button>
          <button class="nav-item" data-view="viewTechnician" data-i18n="navTechnician">Technician</button>
          <button class="nav-item" data-view="viewDispatch" data-i18n="navDispatch">Dispatch</button>
          <button class="nav-item" data-view="viewNodes" data-i18n="navNodes">Nodes</button>
          <button class="nav-item" data-view="viewPhotos" data-i18n="navPhotos">Photos</button>
          <button class="nav-item" data-view="viewBilling" data-i18n="navBilling">Billing</button>
          <button class="nav-item" data-view="viewLabor" data-i18n="navLabor">Labor</button>
          <button class="nav-item" data-view="viewInvoices" data-i18n="navInvoices">Invoices</button>
          <button class="nav-item" data-view="viewMap" data-i18n="navMap">Live Map</button>
          <button class="nav-item" data-view="viewCatalog" data-i18n="navCatalog">Material Catalog</button>
          <button class="nav-item" data-view="viewAlerts"><span data-i18n="navAlerts">Alerts</span> <span id="alertsNavBadge" class="nav-badge"></span></button>
          <button class="nav-item" data-view="viewAdmin" data-i18n="navAdmin">Admin</button>
          <button class="nav-item" data-view="viewSettings" data-i18n="navSettings">Settings</button>
        </nav>
      </aside>

      <main class="content">
        <section id="viewDashboard" class="view active">
          <div class="card job-card">
            <div class="row" style="justify-content:space-between;">
              <div>
                <h2 id="jobTitle">Job 731022136</h2>
                <div id="jobSubtitle" class="muted small" data-i18n="jobSubtitle">Ruidoso FTTH Rebuild (node-by-node workflow)</div>
              </div>
              <div class="no-pay-badge" data-i18n="photosOptionalBadge">Photos optional for MVP</div>
            </div>
            <div id="nodeCards" class="node-grid" style="margin-top:12px;"></div>
          </div>
          <div class="grid cols-2">
            <div class="card">
              <h2 data-i18n="activeNodeTitle">Active node</h2>
              <div class="kpi">
                <div class="tile">
                  <div class="label" data-i18n="kpiNode">Node</div>
                  <div id="dashNode" class="value">None</div>
                </div>
                <div class="tile">
                  <div class="label" data-i18n="kpiCompletion">Completion</div>
                  <div id="dashCompletion" class="value">0%</div>
                </div>
                <div class="tile">
                  <div class="label" data-i18n="kpiUnits">Units</div>
                  <div id="dashUnits" class="value">0 / 0</div>
                </div>
              </div>
              <div style="margin-top:14px;" class="row">
                <span id="chipStatus" class="chip"><span class="dot warn"></span><span>Waiting</span></span>
                <span id="chipRole" class="chip"><span class="dot ok"></span><span>Role: ?</span></span>
                <span id="chipPricing" class="chip"><span class="dot bad"></span><span data-i18n="pricingHidden">Pricing hidden from splicers</span></span>
                <span id="chipBuildMode" class="chip" style="display:none;"><span class="dot warn"></span><span>BUILD MODE (restrictions disabled)</span></span>
              </div>
              <div class="hr"></div>
              <div id="photoChecklistSummary" class="note"></div>
            </div>
            <div class="card">
              <h2 data-i18n="alertsTitle">Alerts</h2>
              <div id="alertsFeed"></div>
            </div>
          </div>
          <div class="grid cols-2" style="margin-top:16px;">
            <div class="card">
              <h2 data-i18n="allowedQuantitiesTitle">Allowed quantities</h2>
              <div id="allowedQuantities"></div>
            </div>
            <div class="card">
              <h2 data-i18n="catalogQuickSearchTitle">Catalog quick search</h2>
              <input id="catalogSearchQuick" class="input" placeholder="Search Millennium part, MFG SKU, description" data-i18n-placeholder="catalogSearchPlaceholder" />
              <div id="catalogResultsQuick" class="catalog-list" style="margin-top:12px;"></div>
            </div>
          </div>
        </section>

        <section id="viewTechnician" class="view">
          <div class="grid cols-2">
            <div class="card">
              <h2 data-i18n="techClockTitle">Time tracking</h2>
              <div id="techClockStatus" class="muted small" style="margin-top:6px;"></div>
              <div class="row" style="margin-top:12px;">
                <button id="btnTechClockIn" class="btn" data-i18n="techClockIn">Clock In</button>
                <button id="btnTechClockOut" class="btn secondary" data-i18n="techClockOut">Clock Out</button>
              </div>
              <div class="hr"></div>
              <div class="muted small" data-i18n="techJobStateLabel">Current state</div>
              <div id="techJobState" class="chip" style="margin-top:8px;"></div>
              <div class="row" style="flex-wrap:wrap; margin-top:12px;">
                <button id="btnTechStartJob" class="btn" data-i18n="techStartJob">Start Job</button>
                <button id="btnTechPauseJob" class="btn secondary" data-i18n="techPauseJob">Pause Job</button>
                <button id="btnTechLunch" class="btn ghost" data-i18n="techLunch">Lunch</button>
                <button id="btnTechBreak" class="btn ghost" data-i18n="techBreak">Break</button>
                <button id="btnTechTruckInspection" class="btn ghost" data-i18n="techTruckInspection">Truck Inspection</button>
                <button id="btnTechEndJob" class="btn danger" data-i18n="techEndJob">End Job</button>
              </div>
              <div class="hr"></div>
              <div id="techEventLog" class="tech-log"></div>
            </div>
            <div class="card">
              <h2 data-i18n="techSummaryTitle">Daily summary</h2>
              <div id="techSummary" style="margin-top:12px;"></div>
              <div class="hr"></div>
              <h3 data-i18n="techLocationTrailTitle">Location trail</h3>
              <div id="techLocationTrail" class="muted small" style="margin-top:8px;"></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="row" style="justify-content:space-between;">
              <h2 data-i18n="techWorkOrdersTitle">Work orders</h2>
              <div class="muted small" data-i18n="techWorkOrdersSubtitle">Assigned installs and trouble tickets</div>
            </div>
            <div class="grid cols-2" style="margin-top:12px;">
              <div>
                <h3 data-i18n="techTodayTitle">Today</h3>
                <div id="techWorkOrdersToday" style="margin-top:10px;"></div>
              </div>
              <div>
                <h3 data-i18n="techTomorrowTitle">Tomorrow</h3>
                <div id="techWorkOrdersTomorrow" style="margin-top:10px;"></div>
              </div>
            </div>
          </div>
        </section>

        <section id="viewNodes" class="view">
          <div class="card">
            <h1 data-i18n="nodesTitle">Node workspace</h1>
            <div class="muted small" data-i18n="nodesSubtitle">Only one ACTIVE node at a time. Finish splicing before moving to the next node.</div>

            <div class="row" style="margin-bottom:12px;">
              <input id="nodeNumber" class="input" placeholder="Enter node number (example: NODE-1001)" data-i18n-placeholder="nodeNumberPlaceholder" />
              <button id="btnOpenNode" class="btn" data-i18n="openNode">Open node</button>
              <button id="btnNewNode" class="btn secondary" data-i18n="createNode">Create node</button>
            </div>

            <div class="hr"></div>

            <h2 data-i18n="spliceLocationsTitle">Splice locations</h2>
            <p class="muted small" data-i18n="spliceLocationsSubtitle">Photos are optional for billing in this MVP.</p>

            <div class="row">
              <button id="btnAddLocation" class="btn secondary" data-i18n="addSpliceLocation">Add splice location</button>
            </div>

            <div id="locations" style="margin-top:12px;"></div>

            <div class="hr"></div>

            <h2 data-i18n="inventoryTitle">Inventory checklist</h2>
            <p class="muted small" data-i18n="inventorySubtitle">What was used at this node. Splicers see items and checklists, not pricing.</p>
            <div id="inventory" style="margin-top:12px;"></div>
          </div>
        </section>



        <section id="viewPhotos" class="view">
          <div class="grid cols-2">
            <div class="card">
              <h2 data-i18n="photoChecklistTitle">Photo checklist</h2>
              <div class="no-pay-banner" data-i18n="photosOptionalBanner">Photos optional for MVP</div>
              <div id="photoChecklist"></div>
            </div>
            <div class="card">
              <h2 data-i18n="capturePhotosTitle">Capture photos</h2>
              <div class="muted small" data-i18n="capturePhotosSubtitle">Camera-only. GPS required at capture time. No gallery uploads.</div>
              <div class="camera-panel">
                <video id="cameraStream" autoplay playsinline muted></video>
              </div>
              <div class="row" style="margin-top:12px;">
                <button id="btnStartCamera" class="btn secondary" data-i18n="startCamera">Start camera</button>
                <button id="btnCapturePhoto" class="btn secondary" data-i18n="captureUsagePhoto">Capture usage photo</button>
              </div>
              <div id="photoStatus" class="muted small" style="margin-top:10px;" data-i18n="photoStatusNone">No photo captured</div>
              <div id="photoPreview" class="photo-preview" style="margin-top:12px;"></div>
              <div class="hr"></div>
              <div id="backfillPanel" class="note backfill-panel" style="display:none;">
                <div style="font-weight:900;">Owner backfill</div>
                <div class="muted small">Upload from device when backfill is enabled for this node.</div>
                <div class="row" style="flex-wrap:wrap; margin-top:8px;">
                  <select id="backfillLocationSelect" class="input" style="min-width:220px; flex:1 1 auto;"></select>
                </div>
                <div class="row" style="flex-wrap:wrap; margin-top:8px;">
                  <label class="btn ghost file-btn">
                    Upload from device (Port test)
                    <input id="backfillPortInput" type="file" accept="image/*" />
                  </label>
                  <label class="btn ghost file-btn">
                    Upload from device (Splice complete)
                    <input id="backfillSpliceInput" type="file" accept="image/*" />
                  </label>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="viewInvoices" class="view">
          <div class="grid cols-2">
            <div class="card">
              <h2 data-i18n="invoiceActionsTitle">Invoice actions</h2>
              <div class="no-pay-banner" data-i18n="invoicesUngatedBanner">Invoices available without proof in MVP</div>
              <div class="muted small" data-i18n="invoiceActionsSubtitle">Billing entry is available in this MVP.</div>
              <div class="row" style="margin-top:12px;">
                <button id="btnMarkNodeReady" class="btn" data-i18n="markNodeReady">Mark node READY for billing</button>
                <button id="btnCreateInvoice" class="btn secondary" data-i18n="createInvoice">Create invoice (role-based)</button>
              </div>
              <div id="readyNote" class="note" style="margin-top:12px; display:none;"></div>
            </div>
            <div class="card">
              <h2 data-i18n="invoicesPrivacyTitle">Invoices and privacy</h2>
              <div class="muted small">
                This panel shows what <b>you</b> can see based on your role.
                In Supabase, RLS policies enforce this server-side.
              </div>

              <div class="hr"></div>
              <div id="invoicePanel"></div>
            </div>
          </div>
        </section>

        <section id="viewBilling" class="view">
          <div class="grid cols-2">
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <h2 data-i18n="billingLocationsTitle">Locations</h2>
                <span id="billingStatus" class="muted small"></span>
              </div>
              <div id="billingLocationList" class="location-list" style="margin-top:12px;"></div>
            </div>
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <h2 data-i18n="billingTitle">Billing</h2>
                <div class="row">
                  <button id="btnImportUsage" class="btn ghost" data-i18n="importUsage">Import usage</button>
                  <button id="btnBillingExportCsv" class="btn ghost" data-i18n="exportCsv">Export CSV</button>
                  <button id="btnBillingPrint" class="btn ghost" data-i18n="print">Print</button>
                </div>
              </div>
              <div id="billingDetail" class="muted small" style="margin-top:12px;" data-i18n="billingSelectLocation">Select a location to start billing.</div>
            </div>
          </div>
        </section>

        <section id="viewDispatch" class="view">
          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h2 data-i18n="dispatchTitle">Dispatch</h2>
              <div class="row" style="flex-wrap:wrap;">
                <button id="btnDispatchCreate" class="btn" data-i18n="dispatchCreate">Create work order</button>
                <button id="btnDispatchImportCsv" class="btn ghost" data-i18n="dispatchImportCsv">Import CSV</button>
                <input id="dispatchCsvInput" type="file" accept=".csv,text/csv" style="display:none;" />
              </div>
            </div>
            <div class="row" style="flex-wrap:wrap; margin-top:12px;">
              <input id="dispatchDateFilter" class="input" type="date" />
              <select id="dispatchStatusFilter" class="input">
                <option value="" data-i18n="dispatchStatusAll">All statuses</option>
              </select>
              <select id="dispatchAssignFilter" class="input">
                <option value="all" data-i18n="dispatchAssignAll">All</option>
                <option value="assigned" data-i18n="dispatchAssignAssigned">Assigned</option>
                <option value="unassigned" data-i18n="dispatchAssignUnassigned">Unassigned</option>
              </select>
            </div>
            <div id="dispatchImportWarnings" class="note warning" style="display:none; margin-top:12px;"></div>
            <div id="dispatchTable" style="margin-top:12px;"></div>
          </div>
        </section>

        <section id="viewLabor" class="view">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <h2 data-i18n="laborTitle">Labor</h2>
              <button id="btnLaborExportCsv" class="btn ghost" data-i18n="exportCsv">Export CSV</button>
            </div>
            <div id="laborTable" style="margin-top:12px;"></div>
          </div>
        </section>

        <section id="viewMap" class="view">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div>
                <h1 data-i18n="mapTitle">Live map</h1>
                <div class="muted small" data-i18n="mapSubtitle">See the latest crew locations (updates every 10-15 seconds).</div>
              </div>
              <div class="row map-controls">
                <label class="checkbox">
                  <input type="checkbox" id="mapActiveOnly" checked />
                  <span data-i18n="mapActiveOnly">Active only (last 10 min)</span>
                </label>
                <input id="mapSearch" class="input" placeholder="Search by name" data-i18n-placeholder="mapSearchPlaceholder" />
              </div>
            </div>
            <div id="liveMap" class="map"></div>
            <div id="mapStatus" class="muted small" style="margin-top:10px;"></div>
          </div>
        </section>

        <section id="viewCatalog" class="view">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <h2 data-i18n="catalogTitle">Material catalog</h2>
              <button id="btnCatalogClear" class="btn ghost" data-i18n="clear">Clear</button>
            </div>
            <div class="row" style="margin-top:12px;">
              <input id="catalogSearch" class="input" placeholder="Search Millennium part, MFG SKU, description" data-i18n-placeholder="catalogSearchPlaceholder" />
            </div>
            <div id="catalogResults" class="catalog-list" style="margin-top:16px;"></div>
          </div>
        </section>

        <section id="viewAlerts" class="view">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <h2 data-i18n="alertsFeedTitle">Alerts feed</h2>
              <span id="alertsBadge" class="badge">No alerts</span>
            </div>
            <div id="alertsFeedFull" style="margin-top:12px;"></div>
          </div>
        </section>

        <section id="viewAdmin" class="view">
          <div class="card">
            <h2 data-i18n="adminNotesTitle">Admin notes</h2>
            <div class="note">
              <div style="font-weight:900;">Next build steps</div>
              <ol class="muted small" style="margin-top:8px;">
                <li>Wire Supabase keys in Netlify env vars.</li>
                <li>Run the SQL schema + RLS in Supabase.</li>
                <li>Enable Storage bucket for photos (private).</li>
                <li>Add real node sheets import and Millennium part lookup.</li>
              </ol>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <h2 data-i18n="userManagementTitle">User management</h2>
            <div class="muted small" data-i18n="userManagementSubtitle">Create/update profile rows for authenticated users. Auth users must already exist in Supabase.</div>
            <div id="adminBuildGate" class="note warning" style="display:none; margin-top:10px;">
              <div style="font-weight:900;">Build mode disabled</div>
              <div class="muted small">Enable BUILD_MODE to manage user profiles.</div>
            </div>
            <div id="adminUsersPanel" style="margin-top:12px;">
              <div class="row" style="flex-wrap:wrap;">
                <input id="adminUserId" class="input" placeholder="Auth user id (UUID)" data-i18n-placeholder="adminUserIdPlaceholder" />
                <input id="adminUserEmail" class="input" placeholder="Email or display name" data-i18n-placeholder="adminUserEmailPlaceholder" />
                <select id="adminUserRole" class="input" style="min-width:180px;">
                  <option value="ADMIN">ADMIN</option>
                  <option value="SPLICER">SPLICER</option>
                  <option value="SUB">SUB</option>
                  <option value="PRIME">PRIME</option>
                  <option value="TDS">TDS</option>
                  <option value="TECHNICIAN">TECHNICIAN</option>
                  <option value="OWNER">OWNER</option>
                </select>
                <button id="btnAdminCreateUser" class="btn secondary" data-i18n="createProfile">Create profile</button>
              </div>
              <div class="hr"></div>
              <div id="adminUsersList"></div>
            </div>
          </div>
        </section>

        <section id="viewSettings" class="view">
          <div class="card">
            <h1 data-i18n="settingsTitle">Settings</h1>
            <div class="field-stack">
              <label class="muted small" data-i18n="languageLabel">Language</label>
              <select id="languageSelect" class="input">
                <option value="en" data-i18n="languageOptionEnglish">English</option>
                <option value="es" data-i18n="languageOptionSpanish">Spanish</option>
              </select>
              <div class="muted small" data-i18n="languageHelp">Changes apply immediately and sync to your profile.</div>
              <div class="row">
                <button id="btnSaveLanguage" class="btn secondary" data-i18n="saveLanguage">Save language</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="profileSetupModal" class="modal" style="display:none;">
      <div class="card modal-card">
        <h2>Choose Language / Elegir idioma</h2>
        <div class="muted small">Select your preferred language to continue.</div>
        <div class="field-stack" style="margin-top:12px;">
          <select id="profileLanguageSelect" class="input">
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
          </select>
          <button id="btnSaveProfileLanguage" class="btn">Save / Guardar</button>
        </div>
      </div>
    </div>

    <div id="dispatchModal" class="modal" style="display:none;">
      <div class="card modal-card" style="max-width:720px;">
        <h2 data-i18n="dispatchModalTitle">Work order</h2>
        <div class="field-stack" style="margin-top:12px;">
          <select id="dispatchType" class="input">
            <option value="INSTALL">INSTALL</option>
            <option value="TROUBLE_TICKET">TROUBLE_TICKET</option>
            <option value="MAINTENANCE">MAINTENANCE</option>
            <option value="SURVEY">SURVEY</option>
          </select>
          <select id="dispatchStatus" class="input">
            <option value="NEW">NEW</option>
            <option value="ASSIGNED">ASSIGNED</option>
            <option value="EN_ROUTE">EN_ROUTE</option>
            <option value="ON_SITE">ON_SITE</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="BLOCKED">BLOCKED</option>
            <option value="COMPLETE">COMPLETE</option>
            <option value="CANCELED">CANCELED</option>
          </select>
          <input id="dispatchScheduledStart" class="input" type="datetime-local" />
          <input id="dispatchScheduledEnd" class="input" type="datetime-local" />
          <input id="dispatchCustomerLabel" class="input" placeholder="Customer name" />
          <input id="dispatchAddress" class="input" placeholder="Address" />
          <div class="row">
            <input id="dispatchLat" class="input" placeholder="Lat" />
            <input id="dispatchLng" class="input" placeholder="Lng" />
          </div>
          <input id="dispatchContactPhone" class="input" placeholder="Contact phone" />
          <input id="dispatchPriority" class="input" type="number" min="1" max="5" placeholder="Priority (1-5)" />
          <input id="dispatchSlaDueAt" class="input" type="datetime-local" />
          <textarea id="dispatchNotes" class="input" rows="3" placeholder="Notes"></textarea>
          <select id="dispatchAssignUser" class="input">
            <option value="">Unassigned</option>
          </select>
        </div>
        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button id="btnDispatchCancel" class="btn ghost" data-i18n="cancelLabel">Cancel</button>
          <button id="btnDispatchSave" class="btn" data-i18n="saveLabel">Save</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div><b>SpecCom</b> -> by <b>Spec Communications, LLC</b></div>
      <div>A product of <b>Fatanett, LLC</b></div>
    </div>
  </div>

  <template id="spliceCodesTemplate">
    <div class="codes-section">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="codes-title" data-role="codes-title">Codes used</div>
        <div data-role="codes-actions"></div>
      </div>
      <div data-role="codes-body"></div>
      <div class="codes-title" data-role="desc-title">Brief description</div>
      <div data-role="desc-body"></div>
    </div>
  </template>

  <div id="toast" class="toast">
    <div id="toastTitle" class="title">Notice</div>
    <div id="toastBody" class="body"></div>
  </div>

  <script src="/.netlify/functions/app-config"></script>
  <script src="./env.generated.js"></script>
  <script src="./env.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module" src="./supabaseClient.js"></script>
  <script type="module" src="./app.js"></script>
</body>
</html>
